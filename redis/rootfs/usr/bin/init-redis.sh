#!/command/with-contenv bashio
set -e

ADDON_CONFIG="/data/options.json"
MAXMEMORY=$(bashio::config 'maxmemory')
MAXMEMORY_POLICY=$(bashio::config 'maxmemory_policy')
TIMEOUT=$(bashio::config 'timeout')
TCP_KEEPALIVE=$(bashio::config 'tcp_keepalive')
DATABASES=$(bashio::config 'databases')
SAVE_INTERVAL=$(bashio::config 'save_interval')
LOG_LEVEL=$(bashio::config 'log_level')
APPENDONLY=$(bashio::config 'appendonly')
APPENDFSYNC=$(bashio::config 'appendfsync')
REQUIREPASS=$(bashio::config 'requirepass')

bashio::log.info "Initializing Redis..."

# Ensure redis data directory exists with proper permissions
bashio::log.info "Setting up Redis directories..."
mkdir -p /data/redis
chown -R redis:redis /data/redis 2>/dev/null || true
chmod 700 /data/redis 2>/dev/null || true

# Create Redis configuration
bashio::log.info "Generating Redis configuration..."
cat > /etc/redis/redis.conf << EOF
# Generated by redis addon initialization

# Network and general
bind 127.0.0.1
protected-mode yes
port 6379
tcp-backlog 511
timeout $TIMEOUT
tcp-keepalive $TCP_KEEPALIVE

# General
daemonize no
supervised no
pidfile /var/run/redis.pid
loglevel $LOG_LEVEL
logfile ""
databases $DATABASES

# Snapshotting (RDB)
save ${SAVE_INTERVAL} 1
save 60 10000
save 3600 100

stop-writes-on-bgsave-error yes
rdbcompression yes
rdbchecksum yes
dbfilename dump.rdb
rdb-del-sync-files no
dir /data/redis

# Replication (for future master-slave setup)
replicaof no one
replica-priority 100

# Security
EOF

# Add password if configured
if [[ -n "$REQUIREPASS" ]]; then
    echo "requirepass $REQUIREPASS" >> /etc/redis/redis.conf
    bashio::log.info "Redis authentication enabled"
else
    echo "# requirepass <disabled - local network only>" >> /etc/redis/redis.conf
    bashio::log.info "Redis authentication disabled (local network only)"
fi

# Memory management
cat >> /etc/redis/redis.conf << EOF

# Memory management
maxmemory $MAXMEMORY
maxmemory-policy $MAXMEMORY_POLICY

# Lazy freeing
lazyfree-lazy-eviction no
lazyfree-lazy-expire no
lazyfree-lazy-server-del no
replica-lazy-flush no
lazyfree-lazy-user-del no

# Client output buffer limits
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# Frequency of lazy free
lazyfree-lazy-user-del no

# Protocol
proto-max-bulk-len 536870912
hz 10

# Dynamic thresholds
dynamic-hz yes

# AOF (Append-Only File)
appendonly $APPENDONLY
appendfilename "appendonly.aof"
appendfsync $APPENDFSYNC

no-appendfsync-on-rewrite no
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 67108864

aof-load-truncated yes
aof-use-rdb-preamble yes

# Lua scripting
lua-time-limit 5000

# Cluster mode
cluster-enabled no

# Module configuration
# loadmodule /path/to/module.so

# Monitoring
monitor-passthrough no

# ACL
aclfile /etc/redis/users.acl

# Keyspace notifications
notify-keyspace-events ""

# Advanced config
hash-max-ziplist-entries 512
hash-max-ziplist-value 64
list-max-ziplist-size -2
list-compress-depth 0
set-max-intset-entries 512
zset-max-ziplist-entries 128
zset-max-ziplist-value 64
hll-sparse-max-bytes 3000

# Streams
stream-node-max-bytes 4096
stream-node-max-entries 100

# Active rehashing
activerehashing yes

# Keyspace hits/misses notifications
latency-monitor-threshold 0

# Event notification defaults
notify-keyspace-events ""

# Slow log
slowlog-log-slower-than 10000
slowlog-max-len 128

# Latency
latency-monitor-threshold 0

# Jemalloc
jemalloc-bg-thread yes
EOF

bashio::log.info "Redis configuration complete"
bashio::log.info "Redis data directory: /data/redis"
bashio::log.info "Max memory: $MAXMEMORY"
bashio::log.info "Eviction policy: $MAXMEMORY_POLICY"
bashio::log.info "Databases: $DATABASES"
bashio::log.info "Persistence: RDB ($SAVE_INTERVAL sec) + AOF ($APPENDFSYNC)"
