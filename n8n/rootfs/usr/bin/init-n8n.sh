#!/command/with-contenv bashio
set -e

LOG_LEVEL=$(bashio::config 'log_level')
DB_TYPE=$(bashio::config 'db_type')
EXECUTION_MODE=$(bashio::config 'execution_mode')
MAX_PARALLEL=$(bashio::config 'max_parallel_executions')
MAX_TIMEOUT=$(bashio::config 'max_execution_timeout')
WEBHOOK_URL=$(bashio::config 'webhook_url')
POSTGRES_HOST=$(bashio::config 'postgres_host')
POSTGRES_DB=$(bashio::config 'postgres_db')
POSTGRES_USER=$(bashio::config 'postgres_user')
POSTGRES_PASSWORD=$(bashio::config 'postgres_password')
REDIS_HOST=$(bashio::config 'redis_host')

bashio::log.info "Initializing n8n add-on..."

# Ensure data directories exist with proper permissions
bashio::log.info "Setting up data directories..."
mkdir -p /data/.n8n /data/custom-extensions /data/workflows /data/credentials
chown -R n8n:n8n /data 2>/dev/null || true

# Create n8n environment file for configuration
bashio::log.info "Configuring n8n environment..."
cat >/data/.env <<EOF
# Generated by n8n add-on initialization
N8N_HOST=127.0.0.1
N8N_PORT=5678
N8N_PROTOCOL=http
N8N_USER_FOLDER=/data
N8N_CUSTOM_EXTENSIONS_PATH=/data/custom-extensions
N8N_LOG_LEVEL=${LOG_LEVEL}
N8N_DEPLOYMENT_TYPE=docker
N8N_BLOCK_ENV_ACCESS_IN_NODE=false
N8N_PERSIST_EXECUTION_DATA=true
N8N_CONCURRENCY_QUEUE_INTERVAL=500
N8N_EXECUTIONS_DATA_MAX_AGE=1

NODE_OPTIONS="--max-old-space-size=2048"
NODE_ENV=production

EXECUTIONS_PROCESS=main
EXECUTIONS_MODE=${EXECUTION_MODE}
MAX_PARALLEL_EXECUTIONS=${MAX_PARALLEL}
MAX_EXECUTION_TIMEOUT=${MAX_TIMEOUT}

GENERIC_FOLDER_BASE_PATH=/share
GENERIC_FOLDER_ENABLED=true

HA_REST_ENABLED=true
HA_INTEGRATION_NAME=home-assistant-rest
EOF

# Database configuration
if [[ ${DB_TYPE} == "postgres" ]]; then
	PG_HOST=${POSTGRES_HOST:-vi-postgres}
	PG_DB=${POSTGRES_DB:-n8n}
	PG_USER=${POSTGRES_USER:-n8n}
	PG_PASS=${POSTGRES_PASSWORD:-changeme}

	{
		echo "DB_TYPE=postgresdb"
		echo "DB_POSTGRESDB_HOST=${PG_HOST}"
		echo "DB_POSTGRESDB_PORT=5432"
		echo "DB_POSTGRESDB_DATABASE=${PG_DB}"
		echo "DB_POSTGRESDB_USER=${PG_USER}"
		echo "DB_POSTGRESDB_PASSWORD=${PG_PASS}"
	} >>/data/.env
else
	{
		echo "DB_TYPE=sqlite"
		echo "DB_SQLITE_PATH=/data/.n8n/n8n.sqlite"
	} >>/data/.env
fi

# Webhook configuration
if [[ -n ${WEBHOOK_URL} ]]; then
	echo "WEBHOOK_URL=${WEBHOOK_URL}" >>/data/.env
fi

# Redis / queue configuration
if [[ -n ${REDIS_HOST} ]]; then
	{
		echo "QUEUE_BULL_REDIS_HOST=${REDIS_HOST}"
		echo "QUEUE_BULL_REDIS_PORT=6379"
		echo "N8N_REDIS_HOST=${REDIS_HOST}"
		echo "N8N_REDIS_PORT=6379"
	} >>/data/.env
elif [[ ${EXECUTION_MODE} == "queue" ]]; then
	bashio::log.warning "Execution mode is 'queue' but no redis_host configured; falling back to regular mode."
	sed -i 's/^EXECUTIONS_MODE=.*/EXECUTIONS_MODE=regular/' /data/.env
fi

bashio::log.info "n8n initialization complete"
bashio::log.info "Data directory: /data"
bashio::log.info "Log level: ${LOG_LEVEL}"
bashio::log.info "Execution mode: $(grep '^EXECUTIONS_MODE' /data/.env | cut -d'=' -f2)"
bashio::log.info "Max parallel executions: ${MAX_PARALLEL}"
