#!/command/with-contenv bashio
set -e

LOG_LEVEL=$(bashio::config 'log_level')
OLLAMA_BASE_URL=$(bashio::config 'ollama_base_url')

bashio::log.info "Initializing Open WebUI..."

# Ensure data directory exists with proper permissions
bashio::log.info "Setting up data directories..."
mkdir -p /data
chown -R openwebui:openwebui /data 2>/dev/null || true
chmod 700 /data 2>/dev/null || true

# Create environment configuration file
bashio::log.info "Configuring Open WebUI environment..."
cat >/data/.env <<EOF
# Generated by open-webui addon initialization

# Base configuration
DATA_DIR=/data
WEBUI_HOST=127.0.0.1
WEBUI_PORT=8080
WEBUI_LOG_LEVEL=${LOG_LEVEL}
WEBUI_ENV=production

# Ollama configuration (External GPU Node)
OLLAMA_BASE_URL=${OLLAMA_BASE_URL}
OLLAMA_NUM_PARALLEL=4

# Security
WEBUI_AUTH=True
WEBUI_AUTH_TRUSTED_EMAIL_HEADER=""
WEBUI_AUTH_TRUSTED_NAME_HEADER=""
WEBUI_AUTH_TRUSTED_ORIGINS="*"

# API configuration
WEBUI_AUTH_ALLOW_SIGNUP=true
WEBUI_AUTH_REQUIRE_EMAIL_VERIFICATION=false

EOF

# Add optional configurations
if ! bashio::config.is_empty 'webui_secret_key'; then
	SECRET_KEY=$(bashio::config 'webui_secret_key')
	echo "WEBUI_SECRET_KEY=${SECRET_KEY}" >>/data/.env
	bashio::log.info "Custom secret key configured"
else
	bashio::log.info "Generating random secret key..."
fi

if ! bashio::config.is_empty 'default_models'; then
	echo "DEFAULT_MODELS=$(bashio::config 'default_models')" >>/data/.env
fi

if bashio::config.true 'enable_web_search'; then
	echo "ENABLE_WEB_SEARCH=true" >>/data/.env
	echo "WEB_SEARCH_ENGINE=$(bashio::config 'web_search_engine')" >>/data/.env
	bashio::log.info "Web search enabled"
fi

if bashio::config.true 'enable_image_generation'; then
	echo "ENABLE_IMAGE_GENERATION=true" >>/data/.env
	if ! bashio::config.is_empty 'automatic_1111_base_url'; then
		echo "AUTOMATIC1111_BASE_URL=$(bashio::config 'automatic_1111_base_url')" >>/data/.env
	fi
	if ! bashio::config.is_empty 'comfyui_base_url'; then
		echo "COMFYUI_BASE_URL=$(bashio::config 'comfyui_base_url')" >>/data/.env
	fi
	bashio::log.info "Image generation enabled"
fi

if ! bashio::config.is_empty 'openai_api_base_url'; then
	echo "OPENAI_API_BASE_URL=$(bashio::config 'openai_api_base_url')" >>/data/.env
	bashio::log.info "OpenAI API endpoint configured"
fi

if ! bashio::config.is_empty 'openai_api_key'; then
	echo "OPENAI_API_KEY=$(bashio::config 'openai_api_key')" >>/data/.env
fi

if bashio::config.true 'enable_model_filter'; then
	echo "ENABLE_MODEL_FILTER=true" >>/data/.env
	if ! bashio::config.is_empty 'model_filter_list'; then
		echo "MODEL_FILTER_LIST=$(bashio::config 'model_filter_list')" >>/data/.env
	fi
	bashio::log.info "Model filter enabled"
fi

bashio::log.info "Open WebUI initialization complete"
bashio::log.info "Data directory: /data"
bashio::log.info "Ollama endpoint: ${OLLAMA_BASE_URL}"
bashio::log.info "Log level: ${LOG_LEVEL}"
